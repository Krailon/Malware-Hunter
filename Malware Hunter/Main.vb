Imports System.Net
Imports System.Net.Sockets
Imports System.Threading

Public Class Main

    Private Const GMAIL_HOST As String = "pop.gmail.com"
    Private Const GMAIL_USER As String = "fear.neverending@gmail.com"
    Private Const GMAIL_PASS As String = ""

    Private AnalysisThread As Thread
    Private StopAnalysis As Boolean

    Private Sub Main_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        txtStagerURL.Text = "http://eu.battle.net.freefor7days-wow-account.net/d.html?ref=https://eu.battle.net/account/management/&app=bam&cr=true"
    End Sub

    Private Sub btnAnalyze_Click(sender As Object, e As EventArgs) Handles btnAnalyze.Click
        If btnAnalyze.Text = "Analyze" Then
            StopAnalysis = False
            txtStagerURL.ReadOnly = True
            btnAnalyze.Text = "Stop"
            Me.Text = "Malware Hunter :: Analyzing..."

            Try
                AnalysisThread = New Thread(AddressOf Analyze)
                AnalysisThread.Start(txtStagerURL.Text)
            Catch ex As Exception

            End Try
        Else
            Dim st As Date

            StopAnalysis = True
            st = Now
            While Now.Subtract(st).TotalSeconds < 10

            End While

            If AnalysisThread.IsAlive Then AnalysisThread.Abort()
            txtStagerURL.ReadOnly = False
            btnAnalyze.Text = "Analyze"
            Me.Text = "Malware Hunter"
        End If
    End Sub

    Private Sub txtStagerURL_TextChanged(sender As Object, e As EventArgs) Handles txtStagerURL.TextChanged
        Dim url As Uri = Nothing

        If txtStagerURL.TextLength > 0 AndAlso Uri.TryCreate(txtStagerURL.Text, UriKind.Absolute, url) Then btnAnalyze.Enabled = True Else btnAnalyze.Enabled = False
    End Sub

    Private Sub Analyze(URL As String)
        Dim buff As String
        Dim cStage As Stage
        Dim done As Boolean = False

        While Not done
            Using client As New WebClient
                PrintUpdate("Fetching " & URL)
                buff = client.DownloadString(URL)
                cStage = New Stage(buff)
                PrintUpdate("Stage type detected as " & cStage.type)
            End Using
        End While
    End Sub

    Private Sub PrintUpdate(Update As String)
        If Me.InvokeRequired Then
            Me.Invoke(Sub(Message As String)
                          PrintUpdate(Message)
                      End Sub, Update)
        Else
            txtOutput.Text &= ">> " & Update & vbCrLf
        End If
    End Sub

End Class
