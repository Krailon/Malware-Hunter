Public Class Stage

    Public Enum StageType
        Phish
        Redirect
        Malware
    End Enum

    Private PhishHints() As String = {"<form?:action=,method=post", "login"}
    Private RedirHints() As String = {"<meta?:http-equip=refresh,content=", "location.?:replace(),href="}
    Private MalwareHints() As String = {}

    Private m_Type As StageType
    Private m_Attribs As Hashtable

    Public ReadOnly Property Type As StageType
        Get
            Return m_Type
        End Get
    End Property

    Public ReadOnly Property Attribute(Name As String) As Object
        Get
            If m_Attribs.ContainsKey(Name) Then Return m_Attribs(Name) Else Throw New Exception("The attribute " & Name & " does not exist")
        End Get
    End Property

    Public ReadOnly Property Attributes As Hashtable
        Get
            Return m_Attribs
        End Get
    End Property

    Public Sub New(Data As String)
        Dim phish As Boolean = True
        Dim redir As Boolean = True
        Dim mal As Boolean = True

        ' Test for phishing
        For Each hint As String In PhishHints
            If Not Data.Contains(hint) Then
                phish = False
                Exit For
            End If
        Next hint

        If phish Then
            m_Type = StageType.Phish
            Exit Sub
        End If

        ' Test for redirect
        For Each hint As String In RedirHints
            If Not Data.Contains(hint) Then
                redir = False
                Exit For
            End If
        Next

        If redir Then
            m_Type = StageType.Redirect
            Exit Sub
        End If

        ' Test for malware
        For Each hint As String In MalwareHints
            If Not Data.Contains(hint) Then
                mal = False
                Exit For
            End If
        Next

        If mal Then
            m_Type = StageType.Malware
        End If
    End Sub

End Class
